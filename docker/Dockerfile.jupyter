ARG BASE_IMAGE=pytorch/pytorch:2.1.0-cuda11.8-cudnn8-devel
FROM ${BASE_IMAGE}

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    ffmpeg \
    libsm6 \
    libxext6 \
    libfontconfig1 \
    libxrender1 \
    libgl1-mesa-glx \
    git \
    wget \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /workspace

# Install Python dependencies
COPY requirements.jupyter.txt .
RUN pip install --no-cache-dir -r requirements.jupyter.txt

# Install Jupyter Lab extensions
RUN jupyter labextension install @jupyter-widgets/jupyterlab-manager
RUN jupyter labextension install plotlywidget

# Create directories
RUN mkdir -p /workspace/{src,data,models,notebooks,configs}

# Copy source code and configs
COPY src/ /workspace/src/
COPY configs/ /workspace/configs/
COPY notebooks/ /workspace/notebooks/

# Set environment variables
ENV PYTHONPATH=/workspace
ENV JUPYTER_CONFIG_DIR=/workspace/.jupyter

# Create Jupyter config
RUN jupyter lab --generate-config
RUN echo "c.ServerApp.ip = '0.0.0.0'" >> /root/.jupyter/jupyter_lab_config.py
RUN echo "c.ServerApp.allow_root = True" >> /root/.jupyter/jupyter_lab_config.py
RUN echo "c.ServerApp.open_browser = False" >> /root/.jupyter/jupyter_lab_config.py

# Expose port
EXPOSE 8888

# Start Jupyter Lab
CMD ["jupyter", "lab", "--ip=0.0.0.0", "--port=8888", "--no-browser", "--allow-root", "--NotebookApp.token=multimodal-llm"]